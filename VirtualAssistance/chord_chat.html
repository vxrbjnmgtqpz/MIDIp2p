<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chord Progression Chat</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .chat-container {
        width: 90%;
        max-width: 500px;
        height: 90vh;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        text-align: center;
        font-weight: bold;
        font-size: 18px;
      }

      .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
        animation: fadeIn 0.3s ease-in;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.agent {
        justify-content: flex-start;
      }

      .message-bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .message.user .message-bubble {
        background: #007aff;
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message.agent .message-bubble {
        background: #34c759;
        color: white;
        border-bottom-left-radius: 4px;
      }

      .message.thinking .message-bubble {
        background: #e9ecef;
        color: #6c757d;
        border-bottom-left-radius: 4px;
        font-style: italic;
      }

      .chat-input-container {
        padding: 15px 20px;
        background: white;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
      }

      .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s;
      }

      .chat-input:focus {
        border-color: #007aff;
      }

      .send-button {
        background: #007aff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        font-size: 18px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .send-button:hover {
        background: #0056cc;
      }

      .send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #666;
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
      }

      .chord-display {
        font-family: "Courier New", monospace;
        font-weight: bold;
        font-size: 16px;
        margin: 8px 0;
      }

      .connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 10px;
        font-size: 12px;
        color: white;
      }

      .connection-status.connected {
        background: #34c759;
      }

      .connection-status.disconnected {
        background: #ff3b30;
      }

      .examples {
        text-align: center;
        color: #666;
        font-size: 12px;
        margin: 20px 0;
      }

      .example-prompt {
        display: inline-block;
        background: #e9ecef;
        padding: 4px 8px;
        margin: 2px;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .example-prompt:hover {
        background: #dee2e6;
      }

      .play-button {
        background: #ff9500;
        color: white;
        border: none;
        border-radius: 15px;
        padding: 6px 12px;
        margin: 8px 0;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .play-button:hover {
        background: #cc7700;
      }

      .play-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .chord-playback {
        margin-top: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        font-size: 11px;
      }

      .style-playback-container {
        margin-top: 12px;
        padding: 12px;
        background: linear-gradient(
          135deg,
          rgba(255, 149, 0, 0.1),
          rgba(255, 149, 0, 0.05)
        );
        border-radius: 10px;
        border: 1px solid rgba(255, 149, 0, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .style-playback-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 6px;
        gap: 10px;
        transition: background-color 0.2s;
      }

      .style-playback-row:hover {
        background: rgba(255, 255, 255, 0.6);
      }

      .style-label {
        font-size: 11px;
        font-weight: bold;
        min-width: 70px;
        color: #444;
      }

      .style-play-button {
        background: #ff9500;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 4px 10px;
        cursor: pointer;
        font-size: 10px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .style-play-button:hover {
        background: #e68600;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .style-play-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .chord-sequence {
        font-size: 10px;
        color: #666;
        font-family: "Monaco", "Menlo", monospace;
        letter-spacing: 1px;
      }

      /* Chord substitution color coding */
      .chord-substitution {
        color: #ff6b35 !important;
        font-weight: bold;
        background: rgba(255, 107, 53, 0.15);
        padding: 2px 6px;
        border-radius: 4px;
        margin: 1px;
        border: 1px solid rgba(255, 107, 53, 0.3);
        box-shadow: 0 1px 3px rgba(255, 107, 53, 0.2);
      }

      /* Database default chord color coding */
      .chord-default {
        color: #34c759 !important;
        font-weight: bold;
        background: rgba(52, 199, 89, 0.15);
        padding: 2px 6px;
        border-radius: 4px;
        margin: 1px;
        border: 1px solid rgba(52, 199, 89, 0.3);
        box-shadow: 0 1px 3px rgba(52, 199, 89, 0.2);
      }

      .chord-legend {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 6px;
        font-size: 9px;
        color: #666;
        padding: 4px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 4px;
      }

      .chord-legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }
    </style>
  </head>
  <body>
    <div class="connection-status disconnected" id="connectionStatus">
      Disconnected
    </div>

    <div class="chat-container">
      <div class="chat-header">üéº Integrated Music Theory Assistant</div>

      <div class="chat-messages" id="chatMessages">
        <div class="message agent">
          <div class="message-bubble">
            üëã Hi! I'm your integrated music theory assistant. I can help you
            with:
            <br /><br />
            üéµ <strong>Emotional Progressions:</strong> "I feel romantic and
            nostalgic"<br />
            üéº <strong>Music Theory:</strong> "Show me a Jazz progression in
            Dorian mode"<br />
            üé∂ <strong>Individual Chords:</strong> "What chord represents deep
            sadness?"<br />
            üîç <strong>Style Comparisons:</strong> "How would happiness sound in
            Jazz vs Classical?"<br />
            üìö <strong>Educational:</strong> "Explain why minor chords sound
            sad" <br /><br />
            üéµ <strong>Audio Playback:</strong> Generated progressions include
            play buttons!
          </div>
        </div>

        <div class="examples">
          Try these examples:<br />
          <span
            class="example-prompt"
            onclick="sendExample('happy and excited')"
            >happy and excited</span
          >
          <span
            class="example-prompt"
            onclick="sendExample('sad and melancholy')"
            >sad and melancholy</span
          >
          <span
            class="example-prompt"
            onclick="sendExample('Jazz progression in Dorian mode')"
            >Jazz progression in Dorian</span
          >
          <span
            class="example-prompt"
            onclick="sendExample('What chord represents love?')"
            >What chord represents love?</span
          >
          <span
            class="example-prompt"
            onclick="sendExample('Compare sadness in Classical vs Jazz')"
            >Compare sadness in Classical vs Jazz</span
          >
        </div>
      </div>

      <div class="chat-input-container">
        <input
          type="text"
          class="chat-input"
          id="chatInput"
          placeholder="Ask about music theory, emotions, or request progressions..."
          maxlength="200"
        />
        <button class="send-button" id="sendButton" onclick="sendMessage()">
          ‚û§
        </button>
      </div>
    </div>

    <script>
      // Configuration
      const SERVER_URL = "http://localhost:5004"; // Updated to match integrated_chat_server.py

      // JSON Chatlog System - Internal persistence without WebSockets
      class ChatLog {
        constructor() {
          this.sessionId = this.generateSessionId();
          this.chatHistory = [];
          this.contextMemory = {
            lastProgression: null,
            lastEmotion: null,
            lastMode: null,
            lastStyle: null,
            conversationTurn: 0,
          };
          this.loadFromStorage();
        }

        generateSessionId() {
          return (
            "chat_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9)
          );
        }

        addEntry(type, content, aiResponse = null) {
          const entry = {
            id: this.generateEntryId(),
            timestamp: new Date().toISOString(),
            sessionId: this.sessionId,
            turn: ++this.contextMemory.conversationTurn,
            type: type, // 'user' or 'agent'
            content: content,
            aiResponse: aiResponse, // Full AI response data
            context: { ...this.contextMemory },
          };

          this.chatHistory.push(entry);
          this.updateContextMemory(aiResponse);
          this.saveToStorage();

          return entry;
        }

        generateEntryId() {
          return (
            "entry_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 6)
          );
        }

        updateContextMemory(aiResponse) {
          if (aiResponse) {
            if (aiResponse.chords) {
              this.contextMemory.lastProgression = aiResponse.chords;
            }
            if (aiResponse.primary_result) {
              if (aiResponse.primary_result.primary_mode) {
                this.contextMemory.lastMode =
                  aiResponse.primary_result.primary_mode;
              }
              if (aiResponse.primary_result.emotion_weights) {
                // Get the top emotion
                const emotions = Object.entries(
                  aiResponse.primary_result.emotion_weights
                );
                if (emotions.length > 0) {
                  const topEmotion = emotions.reduce((a, b) =>
                    a[1] > b[1] ? a : b
                  );
                  this.contextMemory.lastEmotion = topEmotion[0];
                }
              }
            }
          }
        }

        getChatContext() {
          return {
            sessionId: this.sessionId,
            turn: this.contextMemory.conversationTurn,
            lastProgression: this.contextMemory.lastProgression,
            lastEmotion: this.contextMemory.lastEmotion,
            lastMode: this.contextMemory.lastMode,
            lastStyle: this.contextMemory.lastStyle,
            recentHistory: this.chatHistory.slice(-5), // Last 5 exchanges for context
          };
        }

        saveToStorage() {
          try {
            const chatData = {
              sessionId: this.sessionId,
              chatHistory: this.chatHistory,
              contextMemory: this.contextMemory,
              lastSaved: new Date().toISOString(),
            };
            localStorage.setItem("musicChatLog", JSON.stringify(chatData));
          } catch (error) {
            console.warn("Failed to save chat log to localStorage:", error);
          }
        }

        loadFromStorage() {
          try {
            const saved = localStorage.getItem("musicChatLog");
            if (saved) {
              const chatData = JSON.parse(saved);
              // Only restore if it's recent (within 24 hours)
              const lastSaved = new Date(chatData.lastSaved);
              const now = new Date();
              const hoursDiff = (now - lastSaved) / (1000 * 60 * 60);

              if (hoursDiff < 24) {
                this.sessionId = chatData.sessionId;
                this.chatHistory = chatData.chatHistory || [];
                this.contextMemory = {
                  ...this.contextMemory,
                  ...chatData.contextMemory,
                };
                console.log("Restored chat session:", this.sessionId);
              } else {
                console.log("Previous session expired, starting fresh");
              }
            }
          } catch (error) {
            console.warn("Failed to load chat log from localStorage:", error);
          }
        }

        clearSession() {
          this.chatHistory = [];
          this.contextMemory = {
            lastProgression: null,
            lastEmotion: null,
            lastMode: null,
            lastStyle: null,
            conversationTurn: 0,
          };
          this.sessionId = this.generateSessionId();
          this.saveToStorage();
        }

        exportChatLog() {
          return {
            sessionId: this.sessionId,
            chatHistory: this.chatHistory,
            contextMemory: this.contextMemory,
            exportedAt: new Date().toISOString(),
          };
        }
      }

      // Initialize chatlog system
      const chatLog = new ChatLog();

      // DOM elements
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const sendButton = document.getElementById("sendButton");
      const connectionStatus = document.getElementById("connectionStatus");

      // State
      let isConnected = false;
      let isProcessing = false;
      let audioContext = null;

      // Audio Engine for Chord Playback
      class ChordPlayer {
        constructor() {
          this.audioContext = null;
          this.isPlaying = false;
          this.initAudio();
        }

        async initAudio() {
          try {
            this.audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          } catch (error) {
            console.warn("Web Audio API not supported:", error);
          }
        }

        // Roman numeral to semitone mapping (C major scale)
        getRomanNumeralSemitones(romanNumeral) {
          // Clean up "alt" chords by converting them to specific alterations
          let cleanChord = romanNumeral;
          if (cleanChord.includes("alt")) {
            // Convert common alt chords to specific alterations
            cleanChord = cleanChord.replace("V7alt", "V7#5");
            cleanChord = cleanChord.replace("IValt", "IV#11");
            cleanChord = cleanChord.replace("alt", "#5"); // Generic fallback
          }

          const romanToSemitone = {
            // Major chords (uppercase)
            I: [0, 4, 7], // C major
            II: [2, 6, 9], // D major
            III: [4, 8, 11], // E major
            IV: [5, 9, 0], // F major
            V: [7, 11, 2], // G major
            VI: [9, 1, 4], // A major
            VII: [11, 3, 6], // B major

            // Minor chords (lowercase)
            i: [0, 3, 7], // C minor
            ii: [2, 5, 9], // D minor
            iii: [4, 7, 11], // E minor
            iv: [5, 8, 0], // F minor
            v: [7, 10, 2], // G minor
            vi: [9, 0, 4], // A minor
            vii: [11, 2, 6], // B minor

            // Dominant 7th chords
            I7: [0, 4, 7, 10], // C dominant 7
            II7: [2, 6, 9, 0], // D dominant 7
            III7: [4, 8, 11, 2], // E dominant 7
            IV7: [5, 9, 0, 3], // F dominant 7
            V7: [7, 11, 2, 5], // G dominant 7
            VI7: [9, 1, 4, 7], // A dominant 7
            VII7: [11, 3, 6, 9], // B dominant 7

            // Major 7th chords
            IM7: [0, 4, 7, 11], // C major 7
            IIM7: [2, 6, 9, 1], // D major 7
            IIIM7: [4, 8, 11, 3], // E major 7
            IVM7: [5, 9, 0, 4], // F major 7
            VM7: [7, 11, 2, 6], // G major 7
            VIM7: [9, 1, 4, 8], // A major 7
            VIIM7: [11, 3, 6, 10], // B major 7

            // Minor 7th chords
            im7: [0, 3, 7, 10], // C minor 7
            iim7: [2, 5, 9, 0], // D minor 7
            iiim7: [4, 7, 11, 2], // E minor 7
            ivm7: [5, 8, 0, 3], // F minor 7
            vm7: [7, 10, 2, 5], // G minor 7
            vim7: [9, 0, 4, 7], // A minor 7
            viim7: [11, 2, 6, 9], // B minor 7

            // 9th chords (simplified - just add 9th)
            I9: [0, 4, 7, 10, 2], // C add 9
            V9: [7, 11, 2, 5, 9], // G9
            ii9: [2, 5, 9, 0, 4], // D minor 9

            // Sus chords
            Isus4: [0, 5, 7], // C sus4
            IVsus4: [5, 10, 0], // F sus4
            Vsus4: [7, 0, 2], // G sus4

            // Diminished chords
            "i¬∞": [0, 3, 6], // C diminished
            "ii¬∞": [2, 5, 8], // D diminished
            "iii¬∞": [4, 7, 10], // E diminished
            "iv¬∞": [5, 8, 11], // F diminished
            "v¬∞": [7, 10, 1], // G diminished
            "vi¬∞": [9, 0, 3], // A diminished
            "vii¬∞": [11, 2, 5], // B diminished

            // Augmented chords
            "I+": [0, 4, 8], // C augmented
            "II+": [2, 6, 10], // D augmented
            "III+": [4, 8, 0], // E augmented
            "IV+": [5, 9, 1], // F augmented
            "V+": [7, 11, 3], // G augmented
            "VI+": [9, 1, 5], // A augmented
            "VII+": [11, 3, 7], // B augmented

            // Extended chords with flat symbols
            "‚ô≠II": [1, 5, 8], // Db major
            "‚ô≠III": [3, 7, 10], // Eb major
            "‚ô≠V": [6, 10, 1], // Gb major
            "‚ô≠VI": [8, 0, 3], // Ab major
            "‚ô≠VII": [10, 2, 5], // Bb major

            // Flat minor chords
            "‚ô≠ii": [1, 4, 8], // Db minor
            "‚ô≠iii": [3, 6, 10], // Eb minor
            "‚ô≠iv": [5, 8, 0], // F minor (same as iv but explicit)
            "‚ô≠v": [6, 9, 1], // Gb minor
            "‚ô≠vi": [8, 11, 3], // Ab minor
            "‚ô≠vii": [10, 1, 5], // Bb minor

            // Flat diminished chords - THE MISSING ONES!
            "‚ô≠ii¬∞": [1, 4, 7], // Db diminished
            "‚ô≠iii¬∞": [3, 6, 9], // Eb diminished
            "‚ô≠iv¬∞": [5, 8, 11], // F diminished
            "‚ô≠v¬∞": [6, 9, 0], // Gb diminished
            "‚ô≠vi¬∞": [8, 11, 2], // Ab diminished
            "‚ô≠vii¬∞": [10, 1, 4], // Bb diminished - THE BUG FIX!

            // Half-diminished (√∏ symbol)
            ii√∏: [2, 5, 8, 0], // D half-diminished
            vii√∏: [11, 2, 5, 9], // B half-diminished
            "‚ô≠vii√∏": [10, 1, 4, 8], // Bb half-diminished - MISSING!

            // Half-diminished 7th chords (alternative notation)
            ii√∏7: [2, 5, 8, 0], // D half-diminished 7
            vii√∏7: [11, 2, 5, 9], // B half-diminished 7
            "‚ô≠vii√∏7": [10, 1, 4, 8], // Bb half-diminished 7

            // Extended jazz chords
            "IM7#11": [0, 4, 7, 11, 6], // C major 7 #11
            "V7#5": [7, 11, 3, 5], // G7#5 (altered dominant)
            ii7b5: [2, 5, 8, 0], // D half-diminished 7
            "IM7#5": [0, 4, 8, 11], // C major 7 #5
            "I6/9": [0, 4, 7, 9, 2], // C6/9

            // Sharp chords - NEW SYSTEMATIC ADDITION
            "‚ôØI": [1, 5, 8], // ‚ôØI - C#-F-G# (Augmented)
            "‚ôØii": [3, 6, 10], // ‚ôØii - D#-F#-A#
            "‚ôØiii": [5, 8, 0], // ‚ôØiii - F-G#-C
            "‚ôØIV": [6, 10, 1], // ‚ôØIV - F#-A#-C# (Tritone substitute)
            "‚ôØV": [7, 11, 2], // ‚ôØV - G#-B-D (Augmented dominant)
            "‚ôØvi": [9, 0, 4], // ‚ôØvi - A#-C-E
            "‚ôØvii": [11, 2, 6], // ‚ôØvii - B#-D-F#

            // Additional sharp inversions
            "‚ôØIV6": [10, 1, 6], // ‚ôØIV6 - first inversion
            "‚ôØV6": [11, 2, 7], // ‚ôØV6 - first inversion

            // Sharp diminished chords
            "#i¬∞": [1, 4, 7], // C# diminished
            "#ii¬∞": [3, 6, 9], // D# diminished
            "#iii¬∞": [5, 8, 11], // E# diminished
            "#iv¬∞": [6, 9, 0], // F# diminished
            "#v¬∞": [8, 11, 2], // G# diminished
            "#vi¬∞": [10, 1, 4], // A# diminished
            "#vii¬∞": [0, 3, 6], // B# diminished

            // Sharp major chords
            "#I": [1, 5, 8], // C# major
            "#II": [3, 7, 10], // D# major
            "#III": [5, 9, 0], // E# major (F major enharmonic)
            "#IV": [6, 10, 1], // F# major
            "#V": [8, 0, 3], // G# major
            "#VI": [10, 2, 5], // A# major
            "#VII": [0, 4, 7], // B# major (C major enharmonic)

            // Add chords
            iiadd9: [2, 5, 9, 4], // D minor add 9
            Vadd9: [7, 11, 2, 9], // G add 9

            // Common jazz substitutions - CRITICAL FIXES
            N6: [1, 5, 8], // Neapolitan 6th (‚ô≠II6)
            Fr6: [2, 6, 8, 0], // French 6th
            Ger6: [2, 6, 8, 10], // German 6th
            It6: [2, 6, 8], // Italian 6th

            // FIRST INVERSIONS (6 chords) - NEW SYSTEMATIC ADDITION
            I6: [4, 7, 0], // I6 - first inversion of I (E-G-C)
            ii6: [5, 9, 2], // ii6 - first inversion of ii (F-A-D)
            iii6: [7, 11, 4], // iii6 - first inversion of iii (G-B-E)
            IV6: [9, 0, 5], // IV6 - first inversion of IV (A-C-F)
            V6: [11, 2, 7], // V6 - first inversion of V (B-D-G)
            vi6: [0, 4, 9], // vi6 - first inversion of vi (C-E-A)
            vii6: [2, 5, 11], // vii6 - first inversion of vii (D-F-B)

            // SECOND INVERSIONS (6/4 chords) - NEW SYSTEMATIC ADDITION
            "I6/4": [7, 0, 4], // I 6/4 - second inversion of I (G-C-E)
            "ii6/4": [9, 2, 5], // ii 6/4 - second inversion of ii (A-D-F)
            "iii6/4": [11, 4, 7], // iii 6/4 - second inversion of iii (B-E-G)
            "IV6/4": [0, 5, 9], // IV 6/4 - second inversion of IV (C-F-A)
            "V6/4": [2, 7, 11], // V 6/4 - second inversion of V (D-G-B)
            "vi6/4": [4, 9, 0], // vi 6/4 - second inversion of vi (E-A-C)
            "vii6/4": [5, 11, 2], // vii 6/4 - second inversion of vii (F-B-D)

            // SEVENTH CHORD INVERSIONS - NEW SYSTEMATIC ADDITION
            IM76: [4, 7, 11, 0], // IM7 first inversion (E-G-B-C)
            IM765: [7, 11, 0, 4], // IM7 second inversion (G-B-C-E)
            IM743: [11, 0, 4, 7], // IM7 third inversion (B-C-E-G)

            V76: [11, 2, 5, 7], // V7 first inversion (B-D-F-G)
            V765: [2, 5, 7, 11], // V7 second inversion (D-F-G-B)
            V743: [5, 7, 11, 2], // V7 third inversion (F-G-B-D)

            // MINOR CHORD INVERSIONS - NEW SYSTEMATIC ADDITION
            i6: [3, 7, 0], // i6 - first inversion of i (Eb-G-C)
            iv6: [8, 0, 5], // iv6 - first inversion of iv (Ab-C-F)
            v6: [10, 2, 7], // v6 - first inversion of v (Bb-D-G)

            "i6/4": [7, 0, 3], // i 6/4 - second inversion of i (G-C-Eb)
            "iv6/4": [0, 5, 8], // iv 6/4 - second inversion of iv (C-F-Ab)
            "v6/4": [2, 7, 10], // v 6/4 - second inversion of v (D-G-Bb)
          };

          // Debug logging for unmapped chords
          if (!romanToSemitone[cleanChord]) {
            console.warn(
              `‚ö†Ô∏è Unmapped chord: "${cleanChord}" (original: "${romanNumeral}") - defaulting to C major`
            );
          }

          return romanToSemitone[cleanChord] || [0, 4, 7]; // Default to C major
        }

        // Convert semitones to frequencies (Middle C = C4 = 261.63 Hz)
        semitonesToFrequencies(semitones, baseOctave = 4) {
          const baseFreq = 261.63; // C4
          return semitones.map((semitone) => {
            // Handle negative semitones and large values properly
            let normalizedSemitone = ((semitone % 12) + 12) % 12;
            let octaveAdjustment = Math.floor(semitone / 12);

            // Keep all notes in a reasonable range (C3 to C6)
            if (octaveAdjustment < -1) octaveAdjustment = -1;
            if (octaveAdjustment > 2) octaveAdjustment = 2;

            const octave = baseOctave + octaveAdjustment;
            const totalSemitones = normalizedSemitone + (octave - 4) * 12;

            return baseFreq * Math.pow(2, totalSemitones / 12);
          });
        }

        // Create an oscillator for a single note
        createOscillator(frequency, startTime, duration) {
          if (!this.audioContext) return null;

          const oscillator = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();

          // Set up the oscillator
          oscillator.type = "triangle";
          oscillator.frequency.setValueAtTime(frequency, startTime);

          // Set up the envelope (ADSR)
          gainNode.gain.setValueAtTime(0, startTime);
          gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.1); // Attack
          gainNode.gain.exponentialRampToValueAtTime(0.2, startTime + 0.3); // Decay
          gainNode.gain.setValueAtTime(0.2, startTime + duration - 0.2); // Sustain
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            startTime + duration
          ); // Release

          // Connect the nodes
          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);

          return { oscillator, gainNode };
        }

        // Play a single chord with enhanced error handling
        async playChord(romanNumeral, duration = 2.0) {
          if (!this.audioContext) {
            console.warn("Audio context not available");
            throw new Error("Audio not supported in this browser");
          }

          try {
            // Resume audio context if suspended (browser autoplay policy)
            if (this.audioContext.state === "suspended") {
              await this.audioContext.resume();
            }

            // Validate chord input
            if (!romanNumeral || typeof romanNumeral !== "string") {
              throw new Error("Invalid chord specified");
            }

            const semitones = this.getRomanNumeralSemitones(romanNumeral);
            const frequencies = this.semitonesToFrequencies(semitones);
            const startTime = this.audioContext.currentTime + 0.1;

            // Create oscillators for each note in the chord
            const oscillators = frequencies
              .map((freq) => this.createOscillator(freq, startTime, duration))
              .filter((osc) => osc !== null);

            if (oscillators.length === 0) {
              throw new Error("Could not create audio for this chord");
            }

            // Start all oscillators
            oscillators.forEach(({ oscillator }) => {
              oscillator.start(startTime);
              oscillator.stop(startTime + duration);
            });

            return new Promise((resolve) => {
              setTimeout(resolve, duration * 1000 + 100);
            });
          } catch (error) {
            console.error("Chord playback error:", error);
            throw error;
          }
        }

        // Play a chord progression
        async playProgression(chords, chordDuration = 1.5, gap = 0.2) {
          if (this.isPlaying) return;

          this.isPlaying = true;

          try {
            for (let i = 0; i < chords.length; i++) {
              console.log(
                `Playing chord ${i + 1}/${chords.length}: ${chords[i]}`
              );
              await this.playChord(chords[i], chordDuration);

              // Small gap between chords (except for the last one)
              if (i < chords.length - 1) {
                await new Promise((resolve) => setTimeout(resolve, gap * 1000));
              }
            }
          } finally {
            this.isPlaying = false;
          }
        }

        // Get note names from Roman numeral for display
        getChordNotes(romanNumeral) {
          const noteNames = [
            "C",
            "C#",
            "D",
            "D#",
            "E",
            "F",
            "F#",
            "G",
            "G#",
            "A",
            "A#",
            "B",
          ];
          const semitones = this.getRomanNumeralSemitones(romanNumeral);
          const notes = semitones.map((semitone) => noteNames[semitone % 12]);

          // Validate chord structure for debugging
          if (semitones.length >= 3) {
            const intervals = [];
            for (let i = 1; i < semitones.length; i++) {
              let interval = (semitones[i] - semitones[0] + 12) % 12;
              intervals.push(interval);
            }

            // Log unusual chord structures
            const intervalString = intervals.join("-");
            if (!this.isCommonChordStructure(intervals)) {
              console.log(
                `üéµ Chord structure analysis: ${romanNumeral} = ${notes.join(
                  "-"
                )} (intervals: ${intervalString})`
              );
            }
          }

          return notes;
        }

        // Validate common chord structures
        isCommonChordStructure(intervals) {
          const common = [
            [4, 7], // Major triad
            [3, 7], // Minor triad
            [3, 6], // Diminished triad
            [4, 8], // Augmented triad
            [4, 7, 10], // Dominant 7th
            [4, 7, 11], // Major 7th
            [3, 7, 10], // Minor 7th
            [3, 6, 9], // Diminished 7th
            [3, 6, 10], // Half-diminished 7th
            [5, 7], // Sus4
            [2, 7], // Sus2
          ];

          const intervalStr = intervals.join(",");
          return common.some((c) => c.join(",") === intervalStr);
        }
      }

      // Initialize chord player
      const chordPlayer = new ChordPlayer();

      // Chord validation tests - run on page load
      function validateChordMappings() {
        console.log("üîç Running chord mapping validation...");

        const testChords = [
          "‚ô≠vii¬∞", // The original bug
          "vii¬∞",
          "‚ô≠VII",
          "V7",
          "IM7",
          "ii¬∞",
          "‚ô≠ii¬∞",
          "#iv¬∞",
          "N6",
        ];

        testChords.forEach((chord) => {
          const notes = chordPlayer.getChordNotes(chord);
          console.log(`‚úì ${chord}: ${notes.join("-")}`);
        });

        console.log(
          "‚úÖ Chord validation complete - check console for any warnings"
        );
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        chatInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        checkConnection();
        setInterval(checkConnection, 5000); // Check connection every 5 seconds

        // Run chord validation tests
        setTimeout(validateChordMappings, 1000);
      });

      // Connection management
      async function checkConnection() {
        try {
          const response = await fetch(`${SERVER_URL}/health`);
          if (response.ok) {
            setConnectionStatus(true);
          } else {
            setConnectionStatus(false);
          }
        } catch (error) {
          setConnectionStatus(false);
        }
      }

      function setConnectionStatus(connected) {
        isConnected = connected;
        connectionStatus.textContent = connected ? "Connected" : "Disconnected";
        connectionStatus.className = `connection-status ${
          connected ? "connected" : "disconnected"
        }`;
      }

      // Message handling with multi-model support
      function addMessage(
        content,
        type = "agent",
        isThinking = false,
        responseData = null
      ) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type} ${
          isThinking ? "thinking" : ""
        }`;

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = "message-bubble";

        if (isThinking) {
          bubbleDiv.innerHTML = `
                    <div class="typing-indicator">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span style="margin-left: 8px;">${content}</span>
                    </div>
                `;
        } else {
          // Handle markdown-style formatting
          let formattedContent = content
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\n/g, "<br>");

          bubbleDiv.innerHTML = formattedContent;

          // Add interactive features for integrated responses
          if (responseData) {
            addInteractiveFeatures(bubbleDiv, responseData);

            // Special handling for style comparisons
            if (responseData.style_playback_data && responseData.comparisons) {
              addStyleComparisonPlayback(
                bubbleDiv,
                responseData.style_playback_data
              );
            }
          }

          // Log to internal JSON chatlog (but skip thinking messages)
          if (!isThinking) {
            chatLog.addEntry(type, content, responseData);
          }
        }

        messageDiv.appendChild(bubbleDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return messageDiv;
      }

      function addInteractiveFeatures(bubbleDiv, responseData) {
        // Add playback controls for chord progressions or single chords
        const chords = responseData.chords || [];
        if (chords.length > 0) {
          // Pass chord metadata for substitution color coding
          const chordMetadata = responseData.chord_metadata || null;
          addChordPlayback(bubbleDiv, chords, chordMetadata);
        } else if (responseData.chord && responseData.chord.roman_numeral) {
          // Single chord playback
          addSingleChordPlayback(bubbleDiv, responseData.chord);
        }

        // Add voice leading information display
        if (responseData.voice_leading) {
          addVoiceLeadingDisplay(
            bubbleDiv,
            responseData.voice_leading,
            responseData.chords
          );
        }

        // Add detailed emotion display for single chord responses
        if (
          responseData.intent === "single_chord" &&
          responseData.chord &&
          responseData.chord.emotion_weights
        ) {
          addEmotionBreakdown(bubbleDiv, responseData.chord.emotion_weights);
        }

        // Add individual chord analysis breakdown for progression analysis
        if (
          responseData.progression_breakdown &&
          responseData.individual_analysis
        ) {
          addIndividualAnalysisBreakdown(
            bubbleDiv,
            responseData.individual_analysis,
            responseData.chords
          );
        }

        // Add model information
        if (responseData.models_used) {
          addModelInfo(bubbleDiv, responseData);
        }

        // Add follow-up suggestions
        if (responseData.suggestions) {
          addSuggestions(bubbleDiv, responseData.suggestions);
        }

        // Add analysis data if available
        if (responseData.intent) {
          addAnalysisInfo(bubbleDiv, responseData);
        }
      }

      function addSingleChordPlayback(parentDiv, chordData) {
        const playbackDiv = document.createElement("div");
        playbackDiv.className = "chord-playback";

        const playButton = document.createElement("button");
        playButton.className = "play-button";
        playButton.innerHTML = "‚ñ∂Ô∏è Play Chord";
        playButton.onclick = () =>
          playSingleChord(
            chordData.roman_numeral || chordData.chord_symbol,
            playButton
          );

        playbackDiv.appendChild(playButton);

        // Show chord notes for reference
        const notesDiv = document.createElement("div");
        notesDiv.style.fontSize = "10px";
        notesDiv.style.color = "#666";
        notesDiv.style.marginTop = "4px";
        const notes = chordPlayer.getChordNotes(
          chordData.roman_numeral || chordData.chord_symbol
        );
        notesDiv.textContent = `Notes: ${notes.join("-")}`;
        playbackDiv.appendChild(notesDiv);

        parentDiv.appendChild(playbackDiv);
      }

      function addEmotionBreakdown(parentDiv, emotionWeights) {
        const emotionDiv = document.createElement("div");
        emotionDiv.style.marginTop = "10px";
        emotionDiv.style.padding = "8px";
        emotionDiv.style.background = "rgba(0,0,0,0.05)";
        emotionDiv.style.borderRadius = "8px";

        const title = document.createElement("div");
        title.style.fontSize = "12px";
        title.style.fontWeight = "bold";
        title.style.marginBottom = "6px";
        title.textContent = "üé≠ Detailed Emotion Analysis:";
        emotionDiv.appendChild(title);

        // Sort emotions by weight and show non-zero ones
        const sortedEmotions = Object.entries(emotionWeights)
          .filter(([_, weight]) => weight > 0)
          .sort(([, a], [, b]) => b - a);

        if (sortedEmotions.length === 0) {
          const noEmotions = document.createElement("div");
          noEmotions.style.fontSize = "11px";
          noEmotions.style.color = "#666";
          noEmotions.textContent = "No specific emotions detected";
          emotionDiv.appendChild(noEmotions);
        } else {
          sortedEmotions.forEach(([emotion, weight]) => {
            const emotionRow = document.createElement("div");
            emotionRow.style.fontSize = "11px";
            emotionRow.style.marginBottom = "3px";
            emotionRow.style.display = "flex";
            emotionRow.style.justifyContent = "space-between";

            const emotionName = document.createElement("span");
            emotionName.textContent = emotion;

            const emotionBar = document.createElement("div");
            emotionBar.style.width = "60px";
            emotionBar.style.height = "8px";
            emotionBar.style.background = "#ddd";
            emotionBar.style.borderRadius = "4px";
            emotionBar.style.overflow = "hidden";

            const emotionFill = document.createElement("div");
            emotionFill.style.width = `${weight * 100}%`;
            emotionFill.style.height = "100%";
            emotionFill.style.background =
              weight > 0.7 ? "#ff4757" : weight > 0.4 ? "#ffa726" : "#66bb6a";
            emotionBar.appendChild(emotionFill);

            const emotionValue = document.createElement("span");
            emotionValue.textContent = `${(weight * 100).toFixed(0)}%`;
            emotionValue.style.fontSize = "10px";
            emotionValue.style.color = "#666";

            emotionRow.appendChild(emotionName);
            emotionRow.appendChild(emotionBar);
            emotionRow.appendChild(emotionValue);
            emotionDiv.appendChild(emotionRow);
          });
        }

        parentDiv.appendChild(emotionDiv);
      }

      function addChordPlayback(parentDiv, chords, chordMetadata = null) {
        const playbackDiv = document.createElement("div");
        playbackDiv.className = "chord-playback";

        const playButton = document.createElement("button");
        playButton.className = "play-button";
        playButton.innerHTML = "‚ñ∂Ô∏è Play Progression";
        playButton.onclick = () => playChordProgression(chords, playButton);

        const individualButton = document.createElement("button");
        individualButton.className = "play-button";
        individualButton.innerHTML = "üéµ Play Individual";
        individualButton.onclick = () => playIndividualChords(chords);

        playbackDiv.appendChild(playButton);
        playbackDiv.appendChild(individualButton);

        // Show chord notes with color coding for substitutions
        const notesDiv = document.createElement("div");
        notesDiv.style.fontSize = "10px";
        notesDiv.style.marginTop = "4px";
        notesDiv.style.padding = "6px";
        notesDiv.style.background = "rgba(255,255,255,0.3)";
        notesDiv.style.borderRadius = "4px";

        if (chordMetadata && chordMetadata.length > 0) {
          // Color-coded chord display with substitution tracking
          const chordElements = chords.map((chord, index) => {
            const metadata = chordMetadata[index];
            const notes = chordPlayer.getChordNotes(chord);
            const chordText = `${chord}: ${notes.join("-")}`;

            if (metadata && metadata.is_substitution) {
              // Neural substitution - red/orange styling
              return `<span class="chord-substitution" title="üß† Neural substitution: ${metadata.original_chord} ‚Üí ${chord}\nType: ${metadata.substitution_type}">${chordText}</span>`;
            } else {
              // Database default - green styling
              return `<span class="chord-default" title="üìö Database default chord">${chordText}</span>`;
            }
          });
          notesDiv.innerHTML = chordElements.join(" | ");

          // Add enhanced legend for color coding
          const legendDiv = document.createElement("div");
          legendDiv.className = "chord-legend";
          legendDiv.innerHTML = `
            <div class="chord-legend-item">
              <span style="color: #34c759; font-weight: bold; font-size: 12px;">‚óè</span>
              <span>Database Default</span>
            </div>
            <div class="chord-legend-item">
              <span style="color: #ff6b35; font-weight: bold; font-size: 12px;">‚óè</span>
              <span>Neural Substitution</span>
            </div>
          `;
          playbackDiv.appendChild(legendDiv);
        } else {
          // Standard display without color coding
          notesDiv.style.color = "#666";
          const chordNotes = chords
            .map((chord) => {
              const notes = chordPlayer.getChordNotes(chord);
              return `${chord}: ${notes.join("-")}`;
            })
            .join(" | ");
          notesDiv.textContent = chordNotes;
        }

        playbackDiv.appendChild(notesDiv);
        parentDiv.appendChild(playbackDiv);
      }

      function addModelInfo(parentDiv, responseData) {
        const infoDiv = document.createElement("div");
        infoDiv.style.fontSize = "11px";
        infoDiv.style.color = "#888";
        infoDiv.style.marginTop = "8px";
        infoDiv.style.padding = "6px";
        infoDiv.style.background = "rgba(0,0,0,0.05)";
        infoDiv.style.borderRadius = "6px";

        const modelsUsed = responseData.models_used.join(", ");
        const confidence = (responseData.confidence * 100).toFixed(0);
        infoDiv.innerHTML = `ü§ñ Models: ${modelsUsed} | Intent: ${responseData.intent} (${confidence}% confidence)`;

        parentDiv.appendChild(infoDiv);
      }

      function addSuggestions(parentDiv, suggestions) {
        const suggestionsDiv = document.createElement("div");
        suggestionsDiv.style.marginTop = "10px";

        const title = document.createElement("div");
        title.style.fontSize = "12px";
        title.style.fontWeight = "bold";
        title.style.marginBottom = "5px";
        title.textContent = "üí° Try next:";
        suggestionsDiv.appendChild(title);

        suggestions.slice(0, 3).forEach((suggestion) => {
          const suggestionBtn = document.createElement("button");
          suggestionBtn.className = "play-button";
          suggestionBtn.style.fontSize = "10px";
          suggestionBtn.style.margin = "2px";
          suggestionBtn.style.background = "#6c757d";
          suggestionBtn.textContent = suggestion;
          suggestionBtn.onclick = () => {
            chatInput.value = suggestion;
            sendMessage();
          };
          suggestionsDiv.appendChild(suggestionBtn);
        });

        parentDiv.appendChild(suggestionsDiv);
      }

      function addStyleComparisonPlayback(parentDiv, stylePlaybackData) {
        // Create a container for style comparison playback buttons
        const styleContainer = document.createElement("div");
        styleContainer.className = "style-playback-container";

        const title = document.createElement("div");
        title.style.fontSize = "13px";
        title.style.fontWeight = "bold";
        title.style.marginBottom = "10px";
        title.style.color = "#333";
        title.style.textAlign = "center";
        title.textContent = "üéµ Style Playback Examples";
        styleContainer.appendChild(title);

        // Create playback buttons for each style
        Object.entries(stylePlaybackData).forEach(([style, chords]) => {
          if (chords && chords.length > 0) {
            const styleRow = document.createElement("div");
            styleRow.className = "style-playback-row";

            const styleLabel = document.createElement("span");
            styleLabel.className = "style-label";
            styleLabel.textContent = style + ":";

            const playButton = document.createElement("button");
            playButton.className = "style-play-button";
            playButton.innerHTML = `‚ñ∂Ô∏è ${style}`;
            playButton.onclick = () =>
              playStyleProgression(style, chords, playButton);

            const chordDisplay = document.createElement("span");
            chordDisplay.className = "chord-sequence";
            chordDisplay.textContent = chords.join(" ‚Üí ");

            styleRow.appendChild(styleLabel);
            styleRow.appendChild(playButton);
            styleRow.appendChild(chordDisplay);
            styleContainer.appendChild(styleRow);
          }
        });

        parentDiv.appendChild(styleContainer);
      }

      function addAnalysisInfo(parentDiv, responseData) {
        // Add expandable analysis section for theory/educational responses
        if (
          responseData.primary_result &&
          (responseData.intent === "theory_request" ||
            responseData.intent === "educational")
        ) {
          const analysisDiv = document.createElement("div");
          analysisDiv.style.marginTop = "8px";

          const toggleBtn = document.createElement("button");
          toggleBtn.className = "play-button";
          toggleBtn.style.fontSize = "10px";
          toggleBtn.style.background = "#17a2b8";
          toggleBtn.textContent = "üìä Show Analysis";

          const detailsDiv = document.createElement("div");
          detailsDiv.style.display = "none";
          detailsDiv.style.fontSize = "11px";
          detailsDiv.style.marginTop = "5px";
          detailsDiv.style.padding = "8px";
          detailsDiv.style.background = "rgba(0,0,0,0.05)";
          detailsDiv.style.borderRadius = "4px";

          if (responseData.primary_result.style) {
            detailsDiv.innerHTML += `<strong>Style:</strong> ${responseData.primary_result.style}<br>`;
          }
          if (responseData.primary_result.mode) {
            detailsDiv.innerHTML += `<strong>Mode:</strong> ${responseData.primary_result.mode}<br>`;
          }
          if (responseData.emotions) {
            const topEmotions = Object.entries(responseData.emotions)
              .sort(([, a], [, b]) => b - a)
              .slice(0, 3)
              .map(
                ([emotion, weight]) =>
                  `${emotion} (${(weight * 100).toFixed(0)}%)`
              )
              .join(", ");
            detailsDiv.innerHTML += `<strong>Emotions:</strong> ${topEmotions}<br>`;
          }

          let isExpanded = false;
          toggleBtn.onclick = () => {
            isExpanded = !isExpanded;
            detailsDiv.style.display = isExpanded ? "block" : "none";
            toggleBtn.textContent = isExpanded
              ? "üìä Hide Analysis"
              : "üìä Show Analysis";
          };

          analysisDiv.appendChild(toggleBtn);
          analysisDiv.appendChild(detailsDiv);
          parentDiv.appendChild(analysisDiv);
        }
      }

      function removeMessage(messageElement) {
        if (messageElement && messageElement.parentNode) {
          messageElement.parentNode.removeChild(messageElement);
        }
      }

      async function sendMessage() {
        if (!isConnected) {
          alert(
            "Not connected to server. Please refresh the page or check the server."
          );
          return;
        }

        if (isProcessing) return;

        const message = chatInput.value.trim();

        // Enhanced input validation
        if (!message) {
          chatInput.focus();
          return;
        }

        // Check for extremely long input
        if (message.length > 500) {
          alert("Message too long. Please keep it under 500 characters.");
          return;
        }

        // Check for suspicious patterns that might break the system
        const suspiciousPatterns = [
          /script/i,
          /javascript/i,
          /<[^>]*>/, // HTML tags
          /\{\{.*\}\}/, // Template injection
        ];

        for (const pattern of suspiciousPatterns) {
          if (pattern.test(message)) {
            alert("Invalid characters detected. Please use plain text.");
            return;
          }
        }

        // Add user message
        addMessage(message, "user");
        chatInput.value = "";

        // Disable input
        isProcessing = true;
        sendButton.disabled = true;
        chatInput.disabled = true;

        // Add thinking message
        const thinkingMessage = addMessage(
          "Processing with AI music models...",
          "agent",
          true
        );

        try {
          // Use streaming approach with oboe.js-like behavior
          await streamResponse(message, thinkingMessage);
        } catch (error) {
          removeMessage(thinkingMessage);
          console.error("Full error details:", error);

          // Provide more helpful error messages
          let errorMessage = "‚ùå Something went wrong. ";
          if (error.message.includes("Failed to fetch")) {
            errorMessage +=
              "Cannot connect to the server. Please check your connection.";
          } else if (error.message.includes("timeout")) {
            errorMessage += "Request timed out. Please try again.";
          } else if (error.message.includes("500")) {
            errorMessage += "Server error. The AI models might be busy.";
          } else {
            errorMessage += `Error: ${error.message}`;
          }

          addMessage(errorMessage, "agent");
        } finally {
          // Re-enable input
          isProcessing = false;
          sendButton.disabled = false;
          chatInput.disabled = false;
          chatInput.focus();
        }
      }

      async function streamResponse(message, thinkingMessage) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

        try {
          const response = await fetch(`${SERVER_URL}/chat/integrated`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include", // Include session cookies
            body: JSON.stringify({
              message: message,
              context: chatLog.getChatContext(), // Include local chat context
            }),
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            let errorMsg = `Server returned ${response.status}`;
            if (response.status === 500) {
              errorMsg += " - Internal server error (AI models may be busy)";
            } else if (response.status === 404) {
              errorMsg += " - Endpoint not found";
            } else if (response.status === 429) {
              errorMsg += " - Too many requests, please wait";
            }
            throw new Error(errorMsg);
          }

          const data = await response.json();

          // Handle errors from the integrated server
          if (data.error) {
            throw new Error(`AI Processing Error: ${data.error}`);
          }

          // Validate response structure
          if (!data.message && !data.chords && !data.chord) {
            throw new Error("Invalid response format from server");
          }

          // Remove thinking message
          removeMessage(thinkingMessage);

          // Add response with full integrated data for features
          addMessage(
            data.message || "Response received successfully",
            "agent",
            false,
            data
          );

          // Optional: Log response data for debugging
          console.log("Integrated response:", data);
          console.log("Intent detected:", data.intent);
          console.log("Models used:", data.models_used);
          console.log("Confidence:", data.confidence);
        } catch (error) {
          clearTimeout(timeoutId);

          if (error.name === "AbortError") {
            throw new Error("Request timed out after 30 seconds");
          }

          throw error;
        }
      }

      // Audio playback functions
      async function playChordProgression(chords, buttonElement) {
        if (chordPlayer.isPlaying) return;

        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = "‚èπÔ∏è Playing...";
        buttonElement.disabled = true;

        try {
          await chordPlayer.playProgression(chords, 1.5, 0.3);
        } catch (error) {
          console.error("Playback error:", error);
          alert(
            "Audio playback failed. Please check your browser audio settings."
          );
        } finally {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }
      }

      async function playSingleChord(chord, buttonElement) {
        if (chordPlayer.isPlaying) return;

        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = "‚èπÔ∏è Playing...";
        buttonElement.disabled = true;

        try {
          await chordPlayer.playChord(chord, 3.0);
        } catch (error) {
          console.error("Playback error:", error);
          alert(
            "Audio playback failed. Please check your browser audio settings."
          );
        } finally {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }
      }

      async function playIndividualChords(chords) {
        if (chordPlayer.isPlaying) return;

        // Create a modal or alert to show individual chord playback
        const chordList = chords
          .map(
            (chord, index) =>
              `${index + 1}. ${chord} (${chordPlayer
                .getChordNotes(chord)
                .join("-")})`
          )
          .join("\n");

        const selectedIndex = prompt(
          `Select a chord to play:\n\n${chordList}\n\nEnter number (1-${chords.length}):`
        );

        const index = parseInt(selectedIndex) - 1;
        if (index >= 0 && index < chords.length) {
          try {
            await chordPlayer.playChord(chords[index], 3.0);
          } catch (error) {
            console.error("Playback error:", error);
            alert(
              "Audio playback failed. Please check your browser audio settings."
            );
          }
        }
      }

      async function playStyleProgression(styleName, chords, buttonElement) {
        if (chordPlayer.isPlaying) return;

        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = "üîÑ Playing...";
        buttonElement.disabled = true;

        try {
          console.log(`Playing ${styleName} progression:`, chords);
          await chordPlayer.playProgression(chords, 1.2, 0.3); // Slightly faster for style comparisons
        } catch (error) {
          console.error(`${styleName} playback error:`, error);
          alert(`${styleName} playback failed: ${error.message}`);
        } finally {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }
      }

      function sendExample(exampleText) {
        chatInput.value = exampleText;
        sendMessage();
      }

      // Handle browser tab visibility for connection management
      document.addEventListener("visibilitychange", function () {
        if (!document.hidden) {
          checkConnection();
        }
      });

      function addVoiceLeadingDisplay(parentDiv, voiceLeadingData, chords) {
        if (!voiceLeadingData || voiceLeadingData.error) {
          return;
        }

        const voiceLeadingDiv = document.createElement("div");
        voiceLeadingDiv.style.marginTop = "12px";
        voiceLeadingDiv.style.padding = "12px";
        voiceLeadingDiv.style.background =
          "linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05))";
        voiceLeadingDiv.style.borderRadius = "10px";
        voiceLeadingDiv.style.border = "1px solid rgba(102, 126, 234, 0.3)";
        voiceLeadingDiv.style.boxShadow = "0 2px 8px rgba(0, 0, 0, 0.1)";

        const titleDiv = document.createElement("div");
        titleDiv.style.fontWeight = "bold";
        titleDiv.style.fontSize = "13px";
        titleDiv.style.marginBottom = "10px";
        titleDiv.style.color = "#333";
        titleDiv.style.textAlign = "center";
        titleDiv.innerHTML = "üéπ Voice Leading & Register Analysis";
        voiceLeadingDiv.appendChild(titleDiv);

        // Register summary
        const registerSummaryDiv = document.createElement("div");
        registerSummaryDiv.style.marginBottom = "10px";
        registerSummaryDiv.style.padding = "8px";
        registerSummaryDiv.style.background = "rgba(255, 255, 255, 0.6)";
        registerSummaryDiv.style.borderRadius = "6px";
        registerSummaryDiv.style.fontSize = "11px";

        const avgRegister = voiceLeadingData.average_register || 4.5;
        const registerRange = voiceLeadingData.register_range || [4, 5];
        const totalCost = voiceLeadingData.total_voice_leading_cost || 0;

        registerSummaryDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span><strong>üéº Register:</strong> ${avgRegister.toFixed(
              1
            )} (range ${registerRange[0]}-${registerRange[1]})</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span><strong>üéµ Voice Movement:</strong> ${totalCost.toFixed(
              1
            )} semitones total</span>
            ${
              chords && chords.length > 1
                ? `<span><strong>üìä Avg/Chord:</strong> ${(
                    totalCost /
                    (chords.length - 1)
                  ).toFixed(1)} semitones</span>`
                : ""
            }
          </div>
        `;
        voiceLeadingDiv.appendChild(registerSummaryDiv);

        // Individual chord voicings
        const voicedChordsDiv = document.createElement("div");
        voicedChordsDiv.style.marginTop = "8px";

        const voicedChordsToggle = document.createElement("button");
        voicedChordsToggle.className = "play-button";
        voicedChordsToggle.style.fontSize = "10px";
        voicedChordsToggle.style.background = "#667eea";
        voicedChordsToggle.style.width = "100%";
        voicedChordsToggle.innerHTML = "üéπ Show Detailed Voicings";

        const voicingsDetailDiv = document.createElement("div");
        voicingsDetailDiv.style.display = "none";
        voicingsDetailDiv.style.marginTop = "8px";
        voicingsDetailDiv.style.maxHeight = "200px";
        voicingsDetailDiv.style.overflowY = "auto";
        voicingsDetailDiv.style.padding = "6px";
        voicingsDetailDiv.style.background = "rgba(255, 255, 255, 0.8)";
        voicingsDetailDiv.style.borderRadius = "6px";

        let isExpanded = false;
        voicedChordsToggle.onclick = () => {
          isExpanded = !isExpanded;
          voicingsDetailDiv.style.display = isExpanded ? "block" : "none";
          voicedChordsToggle.innerHTML = isExpanded
            ? "üéπ Hide Detailed Voicings"
            : "üéπ Show Detailed Voicings";
        };

        // Populate voicing details
        if (
          voiceLeadingData.voiced_chords &&
          voiceLeadingData.voiced_chords.length > 0
        ) {
          voiceLeadingData.voiced_chords.forEach((voicedChord, index) => {
            const chordDiv = document.createElement("div");
            chordDiv.style.marginBottom = "8px";
            chordDiv.style.padding = "6px";
            chordDiv.style.background =
              index % 2 === 0
                ? "rgba(102, 126, 234, 0.1)"
                : "rgba(118, 75, 162, 0.1)";
            chordDiv.style.borderRadius = "4px";
            chordDiv.style.fontSize = "10px";

            const chordHeader = document.createElement("div");
            chordHeader.style.fontWeight = "bold";
            chordHeader.style.marginBottom = "3px";
            chordHeader.innerHTML = `${index + 1}. ${voicedChord.chord_symbol}`;

            const voicingInfo = document.createElement("div");
            voicingInfo.style.color = "#666";
            voicingInfo.innerHTML = `
              üéµ Notes: ${voicedChord.notes_display || "N/A"}<br>
              üéº Register: ${
                voicedChord.register_range
                  ? voicedChord.register_range.join("-")
                  : "N/A"
              }
              ${
                index > 0
                  ? `<br>üé∂ Movement: ${
                      voicedChord.voice_leading_cost?.toFixed(1) || 0
                    } semitones`
                  : ""
              }
            `;

            chordDiv.appendChild(chordHeader);
            chordDiv.appendChild(voicingInfo);
            voicingsDetailDiv.appendChild(chordDiv);
          });
        } else {
          voicingsDetailDiv.innerHTML =
            "<div style='text-align: center; color: #666; font-style: italic;'>No detailed voicing data available</div>";
        }

        voicedChordsDiv.appendChild(voicedChordsToggle);
        voicedChordsDiv.appendChild(voicingsDetailDiv);
        voiceLeadingDiv.appendChild(voicedChordsDiv);

        // Voice leading quality indicator
        const qualityDiv = document.createElement("div");
        qualityDiv.style.marginTop = "8px";
        qualityDiv.style.textAlign = "center";
        qualityDiv.style.fontSize = "10px";
        qualityDiv.style.color = "#666";

        let qualityText = "üéµ Smooth voice leading";
        let qualityColor = "#34c759";

        if (chords && chords.length > 1) {
          const avgMovement = totalCost / (chords.length - 1);
          if (avgMovement < 2) {
            qualityText = "üåü Excellent voice leading (minimal movement)";
            qualityColor = "#34c759";
          } else if (avgMovement < 4) {
            qualityText = "‚úÖ Good voice leading (smooth transitions)";
            qualityColor = "#ff9500";
          } else {
            qualityText = "‚ö†Ô∏è Challenging voice leading (large movements)";
            qualityColor = "#ff3b30";
          }
        }

        qualityDiv.innerHTML = `<span style="color: ${qualityColor};">${qualityText}</span>`;
        voiceLeadingDiv.appendChild(qualityDiv);

        parentDiv.appendChild(voiceLeadingDiv);
      }

      function addIndividualAnalysisBreakdown(
        parentDiv,
        individualAnalysis,
        chords
      ) {
        if (
          !individualAnalysis ||
          !Array.isArray(individualAnalysis) ||
          individualAnalysis.length === 0
        ) {
          return;
        }

        const breakdownDiv = document.createElement("div");
        breakdownDiv.style.marginTop = "12px";
        breakdownDiv.style.padding = "10px";
        breakdownDiv.style.background = "rgba(0,0,0,0.03)";
        breakdownDiv.style.borderRadius = "8px";
        breakdownDiv.style.border = "1px solid rgba(0,0,0,0.1)";

        const titleDiv = document.createElement("div");
        titleDiv.style.fontWeight = "bold";
        titleDiv.style.fontSize = "12px";
        titleDiv.style.marginBottom = "8px";
        titleDiv.style.color = "#333";
        titleDiv.textContent = "üéµ Detailed Emotion Analysis:";
        breakdownDiv.appendChild(titleDiv);

        // Create analysis for each chord
        individualAnalysis.forEach((analysis, index) => {
          if (!analysis) return;

          const chordDiv = document.createElement("div");
          chordDiv.style.marginBottom = "8px";
          chordDiv.style.padding = "6px";
          chordDiv.style.background = "rgba(255,255,255,0.5)";
          chordDiv.style.borderRadius = "6px";
          chordDiv.style.fontSize = "11px";

          // Chord header with play button
          const headerDiv = document.createElement("div");
          headerDiv.style.display = "flex";
          headerDiv.style.alignItems = "center";
          headerDiv.style.marginBottom = "4px";

          const chordName =
            chords && chords[index] ? chords[index] : `Chord ${index + 1}`;
          const chordLabel = document.createElement("span");
          chordLabel.style.fontWeight = "bold";
          chordLabel.style.marginRight = "8px";
          chordLabel.textContent = `${index + 1}. ${chordName}`;
          headerDiv.appendChild(chordLabel);

          // Individual chord play button
          const playBtn = document.createElement("button");
          playBtn.className = "play-button";
          playBtn.style.fontSize = "9px";
          playBtn.style.padding = "2px 6px";
          playBtn.style.background = "#007bff";
          playBtn.innerHTML = "‚ñ∂Ô∏è";
          playBtn.onclick = async () => {
            try {
              await playSingleChord(chordName, playBtn);
            } catch (error) {
              console.error("Chord playback error:", error);
            }
          };
          headerDiv.appendChild(playBtn);

          chordDiv.appendChild(headerDiv);

          // Display emotion weights
          if (
            analysis.emotion_weights &&
            Object.keys(analysis.emotion_weights).length > 0
          ) {
            const emotionsDiv = document.createElement("div");
            emotionsDiv.style.marginBottom = "4px";

            const topEmotions = Object.entries(analysis.emotion_weights)
              .sort(([, a], [, b]) => b - a)
              .slice(0, 3)
              .filter(([, weight]) => weight > 0);

            if (topEmotions.length > 0) {
              const emotionText = topEmotions
                .map(
                  ([emotion, weight]) =>
                    `${emotion} (${(weight * 100).toFixed(0)}%)`
                )
                .join(", ");
              emotionsDiv.innerHTML = `<span style="color: #666;">üé≠ </span>${emotionText}`;
            } else {
              emotionsDiv.innerHTML = `<span style="color: #666;">üé≠ Neutral emotional content</span>`;
            }

            chordDiv.appendChild(emotionsDiv);
          }

          // Display musical context
          if (analysis.mode_context || analysis.style_context) {
            const contextDiv = document.createElement("div");
            contextDiv.style.color = "#666";
            contextDiv.style.fontSize = "10px";
            const mode = analysis.mode_context || "Unknown";
            const style = analysis.style_context || "Unknown";
            contextDiv.innerHTML = `üéº Context: ${mode} (${style})`;
            chordDiv.appendChild(contextDiv);
          }

          if (analysis.emotional_score !== undefined) {
            const scoreDiv = document.createElement("div");
            scoreDiv.style.color = "#666";
            scoreDiv.style.fontSize = "10px";
            scoreDiv.innerHTML = `üéØ Emotional fit: ${(
              analysis.emotional_score * 100
            ).toFixed(0)}%`;
            chordDiv.appendChild(scoreDiv);
          }

          // Display notes if available
          if (analysis.notes) {
            const notesDiv = document.createElement("div");
            notesDiv.style.color = "#666";
            notesDiv.style.fontSize = "10px";
            notesDiv.innerHTML = `üéµ Notes: ${analysis.notes}`;
            chordDiv.appendChild(notesDiv);
          }

          // Show error if present
          if (analysis.error) {
            const errorDiv = document.createElement("div");
            errorDiv.style.color = "#dc3545";
            errorDiv.style.fontSize = "10px";
            errorDiv.innerHTML = `‚ùå ${analysis.error}`;
            chordDiv.appendChild(errorDiv);
          }

          breakdownDiv.appendChild(chordDiv);
        });

        parentDiv.appendChild(breakdownDiv);
      }
    </script>
  </body>
</html>
